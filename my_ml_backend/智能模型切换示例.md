# 🔄 智能模型切换机制 - 使用示例

## 🎯 **新功能概述**

针对用户反馈的 `429 Too Many Requests` 错误问题，我们全面升级了模型切换机制，现在支持**智能错误识别**和**立即切换**策略。

### 🚨 **触发立即切换的错误类型**

| 错误类型 | 错误代码/描述 | 处理策略 | 示例 |
|---------|-------------|----------|------|
| **🔥 API限流** | `429`, `Too Many Requests` | **立即切换** | Request limit exceeded |
| **🔐 认证失败** | `401`, `403`, `Unauthorized` | **立即切换** | Invalid API key |
| **❌ 模型不存在** | `404`, `Model not found` | **立即切换** | Model unavailable |
| **🚫 服务器错误** | `500`, `502`, `503`, `504` | **立即切换** | Internal server error |
| **⚙️ 模型不支持** | `Invalid model`, `Unsupported` | **立即切换** | Model does not exist |

### 🔄 **需要重试的错误类型**

| 错误类型 | 错误描述 | 处理策略 | 重试次数 |
|---------|---------|----------|----------|
| **🌐 网络超时** | `timeout`, `connection` | **重试后切换** | 2次 |
| **📄 格式错误** | `json`, `parse`, `format` | **重试后切换** | 2次 |
| **📭 空响应** | `empty`, `空响应` | **重试后切换** | 2次 |

## 🔥 **典型场景演示**

### 🚨 **场景1：API限流错误（429）- 立即切换**

```bash
🔄 调用模型: Qwen/Qwen3-Coder-480B-A35B-Instruct (尝试 1/2)
❌ 模型 Qwen/Qwen3-Coder-480B-A35B-Instruct API调用异常: Error code: 429 - {'errors': {'message': 'Request limit exceeded.'}}
🔄 检测到需要立即切换的错误: API限流
🚨 强制切换模型: 立即切换
🔄 模型切换: Qwen/Qwen3-Coder-480B-A35B-Instruct → ZhipuAI/GLM-4.5
📊 切换原因: 立即切换

🔄 调用模型: ZhipuAI/GLM-4.5 (尝试 1/2)
✅ 模型 ZhipuAI/GLM-4.5 恢复正常
✅ 成功识别到实体: 12个
```

### 🌐 **场景2：网络超时错误 - 重试后切换**

```bash
🔄 调用模型: deepseek-ai/DeepSeek-V3.1 (尝试 1/2)
❌ 模型 deepseek-ai/DeepSeek-V3.1 失败: API异常: 网络超时 (连续失败: 1/3)

🔄 调用模型: deepseek-ai/DeepSeek-V3.1 (尝试 2/2)
❌ 模型 deepseek-ai/DeepSeek-V3.1 失败: API异常: 网络超时 (连续失败: 2/3)

🔄 调用模型: deepseek-ai/DeepSeek-V3.1 (尝试 1/2)
❌ 模型 deepseek-ai/DeepSeek-V3.1 失败: API异常: 网络超时 (连续失败: 3/3)
🔄 达到失败阈值，切换到下一个模型...
```

### 📊 **场景3：模型状态统计显示**

```bash
🤖 模型状态统计:
   🎯 当前模型: ZhipuAI/GLM-4.5
   📊 当前失败: 0/3
   📈 失败历史:
     ❌ Qwen3-Coder-480B-A35B-Instruct: 3 次
     ⚠️ DeepSeek-V3.1: 2 次
   🔧 可用模型池: 6 个
     ❌ 已失败 Qwen3-Coder-480B-A35B-Instruct
     🎯 使用中 GLM-4.5
     ✅ 待用 DeepSeek-V3.1
     ✅ 待用 Qwen3-235B-A22B-Instruct-2507
     ✅ 待用 DeepSeek-R1-0528
     ✅ 待用 DeepSeek-R1-0528
   🔄 切换策略: 429错误立即切换，其他错误达到3次后切换
```

## ⚙️ **技术实现细节**

### 🔍 **错误检测机制**

```python
def _should_switch_immediately(self, error_str: str) -> bool:
    """智能检测是否需要立即切换模型"""
    immediate_switch_patterns = [
        # API限流错误 - 立即切换
        "429", "Too Many Requests", "Request limit exceeded",
        # 认证/权限错误 - 立即切换  
        "401", "403", "Unauthorized", "Forbidden",
        # 模型不可用错误 - 立即切换
        "404", "Model not found", "Service unavailable",
        # 服务器内部错误 - 立即切换
        "500", "502", "503", "504"
    ]
    # ... 智能匹配逻辑
```

### 🎯 **切换决策逻辑**

```python
def _handle_model_failure(self, reason: str, force_switch: bool = False):
    """智能失败处理"""
    # 强制切换 OR 达到失败阈值 → 切换模型
    should_switch = force_switch or (consecutive_failures >= max_failures)
    
    if should_switch:
        if force_switch:
            print(f"🚨 强制切换模型: {reason}")  # 429等立即切换
        else:
            print(f"📊 达到失败阈值，切换模型")      # 累积失败切换
```

## 🎉 **用户体验提升**

### ✅ **改进前 vs 改进后**

| 方面 | **改进前** | **改进后** |
|------|-----------|-----------|
| **429错误处理** | 继续重试当前模型 | **立即切换**到可用模型 |
| **切换策略** | 仅基于累积失败次数 | **智能错误识别** + 累积失败 |
| **用户反馈** | 长时间等待无响应 | **快速切换**，立即恢复服务 |
| **错误信息** | 简单的失败提示 | **详细错误分类**和处理策略 |
| **模型状态** | 基础状态显示 | **完整统计信息**和切换历史 |

### 🚀 **性能优化**

- **⚡ 响应速度**：429错误从重试3次（~10秒）优化到立即切换（~1秒）
- **🎯 成功率**：智能切换避免在失效模型上浪费时间
- **📊 透明度**：详细的错误分类和切换统计
- **🔄 可靠性**：6个备用模型确保服务连续性

## 🔧 **配置选项**

### 📋 **模型池配置**

```python
available_models = [
    'Qwen/Qwen3-Coder-480B-A35B-Instruct',    # 主力模型
    'ZhipuAI/GLM-4.5',                        # 备用模型1
    'deepseek-ai/DeepSeek-V3.1',              # 备用模型2
    'Qwen/Qwen3-235B-A22B-Instruct-2507',    # 备用模型3
    'deepseek-ai/DeepSeek-R1-0528',          # 备用模型4
    'deepseek-ai/DeepSeek-R1-0528'           # 备用模型5
]
```

### ⚙️ **切换参数**

```python
max_model_failures = 3          # 累积失败阈值
max_retries_per_model = 2       # 每个模型重试次数
immediate_switch_errors = [     # 立即切换的错误模式
    "429", "Too Many Requests", "401", "403", "404", "500"
]
```

---

**🔥 现在您再遇到429错误，系统会立即切换到下一个可用模型，确保森林火灾知识提取服务不中断！**
