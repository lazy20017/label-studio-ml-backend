# 🔧 auto_config_updater.py - Label Studio 标签配置自动更新器

## 📋 功能简介

`auto_config_updater.py` 是一个专门用于批量更新Label Studio项目标签配置的自动化工具。它能够从`文本命名实体提取标签.md`文件中读取新的标签配置，并自动更新指定的Label Studio项目。

## ✨ 主要功能

- 🔄 **批量更新**: 支持一次性更新多个项目的标签配置
- 📝 **配置解析**: 自动解析Markdown文件中的Label Studio XML配置
- 💾 **配置备份**: 更新前自动备份原有配置，支持回滚
- 🔍 **配置验证**: 验证新配置的XML格式正确性
- 📊 **实时进度**: 显示更新进度和统计信息
- 🔁 **错误重试**: 支持失败项目的自动重试
- 📋 **详细日志**: 记录更新过程和错误信息
- ⚙️ **灵活配置**: 用户可自定义各种参数

## 🚀 使用方法

### 1. 准备工作

确保您已经：
- ✅ Label Studio 服务正在运行
- ✅ 已获取有效的API Token
- ✅ `文本命名实体提取标签.md` 文件包含新的标签配置

### 2. 配置参数

编辑 `auto_config_updater.py` 文件中的配置区域：

```python
# Label Studio 配置
LABEL_STUDIO_URL = "http://localhost:8080"          # Label Studio服务地址
LABEL_STUDIO_API_TOKEN = "your_api_token_here"      # 您的API令牌
PROJECT_IDS = list(range(910, 810, -1))             # 要更新的项目ID列表

# 配置文件路径
CONFIG_FILE_PATH = "文本命名实体提取标签.md"          # 新标签配置文件路径
```

### 3. 运行程序

```bash
# 先运行测试确保程序正常
python test_config_updater.py

# 运行配置更新器
python auto_config_updater.py
```

### 4. 运行流程

1. **加载配置**: 程序从Markdown文件中提取XML配置
2. **验证格式**: 检查XML配置的格式正确性
3. **确认操作**: 显示更新信息，等待用户确认
4. **批量更新**: 逐个更新项目配置
5. **备份保存**: 自动备份原有配置到`config_backups`目录
6. **结果报告**: 显示详细的更新统计信息

## 📊 程序输出示例

```
🌊 Label Studio 标签配置自动更新器
📋 配置文件: 文本命名实体提取标签.md
🎯 目标项目: 100 个
🔗 Label Studio: http://localhost:8080

✅ 成功加载新配置，包含 67 个标签

⚠️ 即将更新 100 个项目的标签配置
   项目ID范围: 810 - 910
   将自动备份原有配置到: config_backups

是否继续？(y/N): y

📊 进度: 1/100 - 处理项目 910
🔄 开始更新项目 910: 洪涝灾害法规项目
✅ 已备份项目 910 配置到: project_910_config_20250128_141230.json
✅ 项目 910 配置更新成功

...

============================================================
🎯 Label Studio 标签配置更新完成！
============================================================
📊 统计信息:
   • 总项目数: 100
   • 成功更新: 95
   • 更新失败: 2
   • 跳过项目: 3
   • 配置备份: 95
   • 总用时: 0:02:15
   • 成功率: 95.0%

💾 配置备份:
   • 备份目录: config_backups
   • 备份文件数: 95
============================================================
```

## 🔧 配置选项说明

### 核心配置

| 参数 | 说明 | 默认值 |
|------|------|--------|
| `LABEL_STUDIO_URL` | Label Studio服务地址 | `http://localhost:8080` |
| `LABEL_STUDIO_API_TOKEN` | API访问令牌 | 需要用户设置 |
| `PROJECT_IDS` | 要更新的项目ID列表 | `range(910, 810, -1)` |
| `CONFIG_FILE_PATH` | 新标签配置文件路径 | `文本命名实体提取标签.md` |

### 更新配置

| 参数 | 说明 | 默认值 |
|------|------|--------|
| `MAX_RETRIES` | 失败项目的最大重试次数 | `3` |
| `REQUEST_TIMEOUT` | 单个请求的超时时间（秒） | `30` |
| `DELAY_BETWEEN_PROJECTS` | 项目间延迟时间（秒） | `1.0` |
| `BACKUP_CONFIGS` | 是否备份原有配置 | `True` |
| `VALIDATE_XML` | 是否验证XML格式 | `True` |

### 备份配置

| 参数 | 说明 | 默认值 |
|------|------|--------|
| `BACKUP_DIR` | 备份目录 | `config_backups` |
| `BACKUP_TIMESTAMP_FORMAT` | 备份时间戳格式 | `%Y%m%d_%H%M%S` |

## 📁 文件结构

```
my_ml_backend/
├── auto_config_updater.py          # 主程序
├── test_config_updater.py           # 测试脚本
├── 文本命名实体提取标签.md           # 新标签配置文件
├── config_backups/                  # 配置备份目录
│   ├── project_910_config_20250128_141230.json
│   ├── project_909_config_20250128_141235.json
│   └── ...
└── logs/                           # 日志目录
    ├── config_update_20250128_141225.log
    └── ...
```

## 🛡️ 安全特性

1. **配置备份**: 更新前自动备份原有配置
2. **用户确认**: 执行前需要用户明确确认
3. **格式验证**: 验证XML配置格式正确性
4. **错误重试**: 失败任务自动重试
5. **详细日志**: 记录所有操作过程

## 🔄 配置回滚

如果需要回滚配置，可以使用备份文件：

1. 在`config_backups`目录中找到对应的备份文件
2. 提取其中的`original_config`字段
3. 手动在Label Studio中恢复配置

## ⚠️ 注意事项

1. **API Token**: 确保API Token有足够的权限修改项目配置
2. **项目存在**: 程序会自动跳过不存在的项目
3. **网络连接**: 确保能够正常访问Label Studio服务
4. **备份空间**: 确保有足够的磁盘空间存储备份文件
5. **并发限制**: 程序串行处理，避免对服务器造成过大压力

## 🧪 测试

运行测试脚本验证程序功能：

```bash
python test_config_updater.py
```

测试项目包括：
- ✅ 配置文件加载
- ✅ XML格式验证
- ✅ 标签计数功能
- ✅ 备份目录创建
- ✅ 连接配置检查

## 📝 日志

程序运行时会在`logs`目录中生成详细的日志文件，包含：
- 操作时间戳
- 成功/失败状态
- 错误详情
- 统计信息

## 🎯 使用场景

- 🔄 **批量升级**: 将所有项目从旧标签配置升级到新配置
- 🏷️ **标准化**: 确保所有项目使用统一的标签规范
- 🔧 **维护更新**: 定期更新项目配置以适应新需求
- 🧪 **测试部署**: 在测试环境中验证新配置

## 💡 最佳实践

1. **测试先行**: 先在少量项目上测试新配置
2. **备份验证**: 定期检查备份文件的完整性
3. **分批处理**: 对于大量项目，可以分批进行更新
4. **监控日志**: 及时查看日志文件发现问题
5. **版本记录**: 记录配置变更的版本和原因

---

**作者**: AI Assistant  
**版本**: 1.0.0  
**创建时间**: 2025-01-28  
**最后更新**: 2025-01-28
