# 图框选标注模型修改报告

## 修改概述

已成功将 `model.py` 从对象检测模板改为图框选标注模板，参考了 `model-pictureTextLabel.py` 的处理逻辑和 `图框选标注标签参数.md` 的标签配置。

## 主要修改内容

### 1. 配置部分修改 ✅

**修改前：**
```python
# ==================== 多模态对象检测配置 ====================
OBJECT_DETECTION_CONFIG = {
    "task_type": "灾害图片对象检测标注",
    "labels": [
        "disaster-causing-factor",      # 致灾因子
        "disaster-victims",            # 受灾体
        "Pregnancy-disaster-environment" # 孕灾环境
    ]
}
```

**修改后：**
```python
# ==================== 多模态图框选标注配置 ====================
RECTANGLE_ANNOTATION_CONFIG = {
    "task_type": "灾害图片框选标注",
    "labels": [
        "积水淹没区域",      # 蓝色
        "受灾建筑物",        # 红色
        "受灾道路",          # 橙色
        "受灾人员",          # 粉色
        "受灾车辆",          # 紫色
        "救援人员",          # 绿色
        "救援车辆",          # 青色
        "树木农田受损区",    # 棕色
        "电力设施",          # 黄色
        "桥梁堤坝",          # 深橙色
        "交通设施",          # 灰色
        "漂浮物"             # 浅蓝色
    ]
}
```

### 2. 全局状态管理 ✅

添加了完整的全局状态管理系统，包括：
- API Key列表管理
- 模型切换逻辑
- 失败重试机制
- 智能错误处理

```python
# 🌍 全局状态管理 - API Key和模型切换
api_key_list = [...]
GLOBAL_API_KEY_INDEX = 0
GLOBAL_CURRENT_API_KEY = api_key_list[GLOBAL_API_KEY_INDEX]

available_models_global = [ 
    "Qwen/Qwen2.5-VL-72B-Instruct",
    "stepfun-ai/step3",
]
```

### 3. 类描述和方法更新 ✅

**修改前：**
```python
class NewModel(LabelStudioMLBase):
    """Custom ML Backend model for object detection"""
    
    def predict(self, tasks: List[Dict], context: Optional[Dict] = None, **kwargs) -> ModelResponse:
        """ 灾害图片对象检测预测 """
```

**修改后：**
```python
class NewModel(LabelStudioMLBase):
    """Custom ML Backend model for rectangle annotation"""
    
    def predict(self, tasks: List[Dict], context: Optional[Dict] = None, **kwargs) -> ModelResponse:
        """ 灾害图片框选标注预测 """
```

### 4. API提示词更新 ✅

**修改前：**
```python
prompt = """请分析这张灾害图片，识别并标注以下三类对象：
1. disaster-causing-factor (致灾因子)
2. disaster-victims (受灾体)  
3. Pregnancy-disaster-environment (孕灾环境)
```

**修改后：**
```python
prompt = """请分析这张灾害图片，识别并标注以下区域和对象：

标注类别（请从以下类别中选择合适的进行标注）：
1. 积水淹没区域 - 被洪水淹没的区域
2. 受灾建筑物 - 受到灾害影响的建筑物
3. 受灾道路 - 受到灾害影响的道路
...（共12个类别）
```

### 5. 结果格式化修改 ✅

**修改前：**
```python
def _format_detection_prediction(self, api_response: str, task: Dict) -> Dict:
    if 'objects' in detection_data:
        for obj in detection_data['objects']:
```

**修改后：**
```python
def _format_annotation_prediction(self, api_response: str, task: Dict) -> Dict:
    if 'annotations' in detection_data:
        for obj in detection_data['annotations']:
```

### 6. 智能API调用 ✅

添加了智能切换版本的API调用方法：
```python
def _call_multimodal_api_with_switching(self, prompt: str, image_data: str) -> Optional[str]:
    """🚀 智能切换版本的多模态API调用（使用全局状态管理）"""
```

包含：
- 自动失败重试
- 智能模型切换
- 错误类型分析
- 连接状态管理

### 7. 错误处理增强 ✅

添加了完整的错误处理机制：
- `_should_switch_immediately()` - 判断立即切换的错误
- `_get_error_type()` - 错误类型分类
- `_handle_failure()` - 失败处理逻辑
- `_handle_success()` - 成功处理逻辑

### 8. 状态监控 ✅

添加了状态监控方法：
```python
def _print_status(self):
    """📊 简化的状态显示"""

def get_status(self) -> Dict:
    """🔍 获取简化状态信息"""
```

## 兼容性保证

✅ 保持了与Label Studio的完全兼容性
✅ 支持RectangleLabels标注格式
✅ 动态字段名获取
✅ 百分比坐标系统
✅ 多模态图片处理

## 新增功能特性

1. **多API Key支持** - 8个备用API Key自动切换
2. **多模型支持** - 2个多模态模型智能切换
3. **智能错误处理** - 根据错误类型决定重试或切换策略
4. **状态监控** - 实时监控API使用状态和切换情况
5. **超时保护** - 250秒超时设置，适合大模型处理
6. **连接优化** - 延迟初始化，按需连接

## 测试建议

1. 上传测试图片到Label Studio
2. 验证12种标注类别的识别效果
3. 测试API切换机制
4. 验证坐标准确性
5. 检查错误处理逻辑

## 版本信息

- 模型版本：2.0.0-多账号切换版
- 任务类型：灾害图片框选标注
- 输出格式：矩形框标注（百分比坐标）
- 支持的标注类别：12种灾害相关类别

修改完成时间：2025年9月13日
